<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Game</title>
	<style>
		div {
			font-size: 0.8em;
			white-space: pre-wrap;
		}
	</style>
</head>
<body>
	<h1>Bienvenido al juego</h1>
    {{ game_id|json_script:"room-name" }}
	<h1>N players:</h1>
	<p id="n_players"></p>
	<h3>Player 1:</h3>
	<p id="player1_direction"></p>
	<h3>Player 2:</h3>
	<p id="player2_direction"></p>
	<script>
		const gameId = location.href.split("/")[4] ? location.href.split("/")[4] : "error";
		const gameSocket = new WebSocket(`ws://${window.location.host}/wss/game/${gameId}/`);
		let player_id = "";

		gameSocket.onmessage = messageHandler;

		gameSocket.onclose = function(e) {
			console.error("Game socket closed unexpectedly");
		};

		function messageHandler(event) {
			const messageData = JSON.parse(event.data);
			if (messageData.type === "gamestate_update") {
				//setGameObjects(messageData.objects);
				console.log(messageData.objects);
				document.getElementById("player1_direction").textContent = messageData.objects[0].direction;
				document.getElementById("player2_direction").textContent = messageData.objects[1].direction;
				document.getElementById("n_players").textContent = messageData.objects.length;

			} else if (messageData.type === "player_join") {
				//setPlayerId(messageData.player_id)
				console.log("Welcome player " + messageData.player_id + "!!");
				player_id = messageData.player_id;
			}
		}
		document.addEventListener(
			"keydown",
			(event) => {
				var name = event.key;
				if (name == "ArrowUp" || name == "w")
				{
					gameSocket.send(
						JSON.stringify({ movement: "up", player: player_id })
					)
				}
				if (name == "ArrowDown" || name == "s")
				{
					gameSocket.send(
						JSON.stringify({ movement: "down", player: player_id })
					)
				}
			},
			false,
		);
		document.addEventListener(
			"keyup",
			(event) => {
				var name = event.key;
				if (name == "ArrowDown" || name == "w")
				{
					gameSocket.send(
						JSON.stringify({ movement: "", player: player_id })
					)
				}
				if (name == "ArrowUp" || name == "s")
				{
					gameSocket.send(
						JSON.stringify({ movement: "", player: player_id })
					)
				}
			},
			false,
		);

	</script>
</body>
</html>